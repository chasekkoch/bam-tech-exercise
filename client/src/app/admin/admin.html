<div class="admin-page">
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <nav aria-label="Breadcrumb" class="breadcrumb">
    <ol>
      <li><a routerLink="/">Home</a></li>
      <li aria-current="page">Admin Dashboard</li>
    </ol>
  </nav>

  <header class="page-header">
    <div class="header-content">
      <h1 id="main-content">System Health Dashboard</h1>
      <p class="subtitle">Monitor the status of all system components and dependencies</p>
    </div>
    <div class="header-actions">
      <button 
        (click)="loadHealthStatus()" 
        class="btn btn-secondary"
        [disabled]="loading()"
        [attr.aria-busy]="loading()"
        aria-label="Refresh health status"
      >
        @if (loading()) {
          <span class="spinner-sm" aria-hidden="true"></span>
          <span>Refreshing...</span>
        } @else {
          <span>üîÑ</span>
          <span>Refresh</span>
        }
      </button>
      <button 
        (click)="toggleAutoRefresh()" 
        class="btn"
        [class.btn-primary]="autoRefresh()"
        [class.btn-secondary]="!autoRefresh()"
        aria-label="Toggle automatic refresh"
        [attr.aria-pressed]="autoRefresh()"
      >
        <span>{{ autoRefresh() ? '‚è∏' : '‚ñ∂' }}</span>
        <span>{{ autoRefresh() ? 'Pause' : 'Resume' }} Auto-Refresh</span>
      </button>
      <button 
        (click)="forceException()" 
        class="btn btn-danger"
        [disabled]="triggeringException()"
        [attr.aria-busy]="triggeringException()"
        aria-label="Force exception for testing"
        title="Trigger a test exception to verify error handling and logging"
      >
        @if (triggeringException()) {
          <span class="spinner-sm" aria-hidden="true"></span>
          <span>Testing...</span>
        } @else {
          <span>‚ö†Ô∏è</span>
          <span>Force Exception</span>
        }
      </button>
    </div>
  </header>

  <!-- Exception Info Modal -->
  @if (exceptionInfo()) {
    <div class="exception-modal" role="alert" aria-live="assertive">
      <div class="exception-modal-content">
        <div class="exception-modal-header">
          <h2>Exception Triggered Successfully</h2>
          <button 
            (click)="clearExceptionInfo()" 
            class="close-button"
            aria-label="Close exception info"
          >
            ‚úï
          </button>
        </div>
        <div class="exception-modal-body">
          <p class="exception-message">
            {{ exceptionInfo()!.message }}
          </p>
          <div class="exception-details">
            <div class="exception-detail-row">
              <span class="detail-label">Exception ID:</span>
              <span class="detail-value exception-id">{{ exceptionInfo()!.exceptionId }}</span>
              <button 
                (click)="copyToClipboard(exceptionInfo()!.exceptionId)"
                class="btn btn-copy"
                aria-label="Copy exception ID to clipboard"
                title="Copy to clipboard"
              >
                üìã
              </button>
            </div>
            <div class="exception-detail-row">
              <span class="detail-label">Trace ID:</span>
              <span class="detail-value">{{ exceptionInfo()!.traceId }}</span>
            </div>
            <div class="exception-detail-row">
              <span class="detail-label">Timestamp:</span>
              <span class="detail-value">{{ formatTimestamp(exceptionInfo()!.timestamp) }}</span>
            </div>
          </div>
          <div class="exception-info-message">
            <p>
              <strong>‚ÑπÔ∏è Report this error:</strong> 
              Please provide the Exception ID above to system administrators for investigation. 
              This exception has been logged to OpenSearch for analysis.
            </p>
          </div>
        </div>
        <div class="exception-modal-footer">
          <button 
            (click)="clearExceptionInfo()" 
            class="btn btn-primary"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Last Updated Info -->
  @if (lastUpdated()) {
    <div class="last-updated" role="status" aria-live="polite">
      Last updated: {{ getRelativeTime(lastUpdated()!) }}
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-container" role="alert">
      <h2>Error Loading Health Status</h2>
      <p>{{ error() }}</p>
      <button (click)="loadHealthStatus()" class="btn btn-primary">Try Again</button>
    </div>
  }

  <!-- Overall Status Card -->
  @if (healthData() && !error()) {
    <section aria-label="Overall system status">
      <div class="overall-status" [class]="getStatusClass(healthData()!.status)">
        <div class="status-icon" aria-hidden="true">
          {{ getStatusIcon(healthData()!.status) }}
        </div>
        <div class="status-content">
          <h2>Overall Status: {{ healthData()!.status }}</h2>
          <p>
            System checked at {{ formatTimestamp(healthData()!.timestamp) }}
            <span class="separator">‚Ä¢</span>
            Total response time: {{ formatDuration(healthData()!.totalDuration) }}
          </p>
        </div>
      </div>
    </section>

    <!-- Component Health Cards -->
    <section aria-label="Component health status">
      <h2 class="section-title">Component Status</h2>
      <div class="health-grid">
        @for (component of healthData()!.components; track component.name) {
          <article class="health-card" [class]="getStatusClass(component.status)">
            <div class="card-header">
              <div class="component-name">
                <span class="status-icon" aria-hidden="true">
                  {{ getStatusIcon(component.status) }}
                </span>
                <h3>{{ component.name | titlecase }}</h3>
              </div>
              <span 
                class="status-badge" 
                [class]="getStatusClass(component.status)"
                role="status"
              >
                {{ component.status }}
              </span>
            </div>

            <div class="card-body">
              @if (component.description) {
                <p class="description">{{ component.description }}</p>
              }

              <div class="metrics">
                <div class="metric">
                  <span class="metric-label">Response Time:</span>
                  <span class="metric-value">{{ formatDuration(component.duration) }}</span>
                </div>

                @if (component.tags && component.tags.length > 0) {
                  <div class="metric">
                    <span class="metric-label">Tags:</span>
                    <span class="metric-value">
                      @for (tag of component.tags; track tag) {
                        <span class="tag">{{ tag }}</span>
                      }
                    </span>
                  </div>
                }

                @if (component.data) {
                  <div class="metric">
                    <span class="metric-label">Details:</span>
                    <span class="metric-value">
                      @for (entry of component.data | keyvalue; track entry.key) {
                        <span class="data-entry">{{ entry.key }}: {{ entry.value }}</span>
                      }
                    </span>
                  </div>
                }
              </div>

              @if (component.exception) {
                <div class="exception" role="alert">
                  <strong>Error:</strong>
                  <p>{{ component.exception.message }}</p>
                  <small>Type: {{ component.exception.type }}</small>
                </div>
              }
            </div>
          </article>
        }
      </div>
    </section>

    <!-- Trending Exceptions Section -->
    @if (trendingExceptions() && trendingExceptions()!.enabled) {
      <section aria-label="Trending exceptions">
        <div class="section-header">
          <h2 class="section-title">Trending Exceptions (Last 24h)</h2>
          <button 
            (click)="toggleTrendingExpanded()" 
            class="btn btn-secondary btn-expand"
            aria-label="Toggle expanded view"
          >
            <span>{{ trendingExpanded() ? '‚ñº Collapse' : '‚ñ∂ Expand' }}</span>
          </button>
        </div>

        @if (loadingTrending()) {
          <div class="loading-mini">
            <span class="spinner-sm"></span>
            <span>Loading...</span>
          </div>
        } @else if (trendingExceptions()!.data.length === 0) {
          <div class="empty-state">
            <p>‚úì No exceptions in the last 24 hours</p>
          </div>
        } @else {
          <div class="trending-grid">
            @for (trend of trendingExceptions()!.data; track trend.exceptionType) {
              <div class="trending-card">
                <div class="trending-header">
                  <h3>{{ trend.exceptionType }}</h3>
                  <span class="badge badge-error">{{ trend.count }}</span>
                </div>
                <div class="trending-body">
                  @if (trend.messages.length > 0) {
                    <div class="message-list">
                      @for (msg of trend.messages; track msg.message) {
                        <div class="message-item">
                          <span class="message-text">{{ msg.message }}</span>
                          <span class="message-count">√ó{{ msg.count }}</span>
                        </div>
                      }
                    </div>
                  }
                  @if(trend.latestException) {
                    <div class="latest-info">
                      <small>Latest: {{ formatTimestamp(trend.latestException.timestampUtc) }}</small>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Expanded Exceptions View -->
          @if (trendingExpanded()) {
            <div class="expanded-view">
              <h3 class="expanded-title">All Exceptions</h3>
              
              @if (loadingExceptions()) {
                <div class="loading-mini">
                  <span class="spinner-sm"></span>
                  <span>Loading exceptions...</span>
                </div>
              } @else if (exceptionsList()) {
                <div class="exceptions-table-container">
                  <table class="exceptions-table">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Type</th>
                        <th>Message</th>
                        <th>Path</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (exception of exceptionsList()!.data; track exception.exceptionId) {
                        <tr>
                          <td>{{ formatTimestamp(exception.timestampUtc) }}</td>
                          <td><span class="badge badge-error">{{ exception.exceptionType }}</span></td>
                          <td class="message-cell">{{ exception.message }}</td>
                          <td class="path-cell">{{ exception.method }} {{ exception.path }}</td>
                          <td><span class="status-badge" [class]="getStatusCodeClass(exception.statusCode)">{{ exception.statusCode }}</span></td>
                          <td>
                            <button 
                              (click)="selectException(exception)"
                              class="btn-link"
                              aria-label="View stack trace"
                            >
                              View Details
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                @if (exceptionsList()!.totalPages > 1) {
                  <div class="pagination">
                    <button 
                      (click)="goToExceptionsPage(exceptionsPage() - 1)"
                      [disabled]="exceptionsPage() === 1"
                      class="btn btn-secondary btn-sm"
                      aria-label="Previous page"
                    >
                      ‚Üê Previous
                    </button>
                    <span class="pagination-info">
                      Page {{ exceptionsPage() }} of {{ exceptionsList()!.totalPages }}
                      ({{ exceptionsList()!.total }} total)
                    </span>
                    <button 
                      (click)="goToExceptionsPage(exceptionsPage() + 1)"
                      [disabled]="exceptionsPage() === exceptionsList()!.totalPages"
                      class="btn btn-secondary btn-sm"
                      aria-label="Next page"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                }
              }
            </div>
          }
        }
      </section>
    }

    <!-- Request Stats Section -->
    @if (requestStats() && requestStats()!.enabled) {
      <section aria-label="Endpoint statistics">
        <div class="section-header">
          <h2 class="section-title">Endpoint Statistics (Last 24h)</h2>
          <button 
            (click)="toggleRequestStatsExpanded()" 
            class="btn btn-secondary btn-expand"
            aria-label="Toggle expanded view"
          >
            <span>{{ requestStatsExpanded() ? '‚ñº Collapse' : '‚ñ∂ Expand' }}</span>
          </button>
        </div>

        @if (loadingRequestStats()) {
          <div class="loading-mini">
            <span class="spinner-sm"></span>
            <span>Loading...</span>
          </div>
        } @else if (requestStats()!.data.length === 0) {
          <div class="empty-state">
            <p>No requests in the last 24 hours</p>
          </div>
        } @else {
          <div class="stats-grid">
            @for (stat of requestStats()!.data; track stat.path) {
              <div class="stat-card">
                <div class="stat-header">
                  <h3>{{ stat.path }}</h3>
                  <span class="badge badge-info">{{ stat.totalRequests }}</span>
                </div>
                <div class="stat-body">
                  <div class="stat-row">
                    <span class="stat-label">Methods:</span>
                    <span class="stat-value">
                      @for (method of stat.methods; track method.method) {
                        <span class="tag">{{ method.method }} ({{ method.count }})</span>
                      }
                    </span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Avg Duration:</span>
                    <span class="stat-value">{{ formatDuration(stat.avgDurationMs || 0) }}</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Max Duration:</span>
                    <span class="stat-value">{{ formatDuration(stat.maxDurationMs || 0) }}</span>
                  </div>
                  @if (stat.statusCodes.length > 0) {
                    <div class="stat-row">
                      <span class="stat-label">Status Codes:</span>
                      <span class="stat-value">
                        @for (status of stat.statusCodes; track status.statusCode) {
                          <span class="status-badge" [class]="getStatusCodeClass(status.statusCode)">
                            {{ status.statusCode }} ({{ status.count }})
                          </span>
                        }
                      </span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Expanded Requests View -->
          @if (requestStatsExpanded()) {
            <div class="expanded-view">
              <h3 class="expanded-title">All Requests</h3>
              
              @if (loadingRequests()) {
                <div class="loading-mini">
                  <span class="spinner-sm"></span>
                  <span>Loading requests...</span>
                </div>
              } @else if (requestsList()) {
                <div class="requests-table-container">
                  <table class="requests-table">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Method</th>
                        <th>Path</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>IP</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (request of requestsList()!.data; track request.requestId) {
                        <tr>
                          <td>{{ formatTimestamp(request.timestampUtc) }}</td>
                          <td><span class="badge badge-method">{{ request.method }}</span></td>
                          <td class="path-cell">{{ request.path }}</td>
                          <td><span class="status-badge" [class]="getStatusCodeClass(request.statusCode)">{{ request.statusCode }}</span></td>
                          <td>{{ formatDuration(request.durationMs) }}</td>
                          <td class="ip-cell">{{ request.remoteIp || 'N/A' }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                @if (requestsList()!.totalPages > 1) {
                  <div class="pagination">
                    <button 
                      (click)="goToRequestsPage(requestsPage() - 1)"
                      [disabled]="requestsPage() === 1"
                      class="btn btn-secondary btn-sm"
                      aria-label="Previous page"
                    >
                      ‚Üê Previous
                    </button>
                    <span class="pagination-info">
                      Page {{ requestsPage() }} of {{ requestsList()!.totalPages }}
                      ({{ requestsList()!.total }} total)
                    </span>
                    <button 
                      (click)="goToRequestsPage(requestsPage() + 1)"
                      [disabled]="requestsPage() === requestsList()!.totalPages"
                      class="btn btn-secondary btn-sm"
                      aria-label="Next page"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                }
              }
            </div>
          }
        }
      </section>
    }

    <!-- Exception Detail Modal -->
    @if (selectedException()) {
      <div class="exception-modal" role="dialog" aria-labelledby="exception-detail-title">
        <div class="exception-modal-content exception-detail-modal">
          <div class="exception-modal-header">
            <h2 id="exception-detail-title">Exception Details</h2>
            <button 
              (click)="clearSelectedException()" 
              class="close-button"
              aria-label="Close exception details"
            >
              ‚úï
            </button>
          </div>
          <div class="exception-modal-body">
            <div class="exception-details">
              <div class="exception-detail-row">
                <span class="detail-label">Exception ID:</span>
                <span class="detail-value exception-id">{{ selectedException()!.exceptionId }}</span>
                <button 
                  (click)="copyToClipboard(selectedException()!.exceptionId)"
                  class="btn btn-copy"
                  aria-label="Copy exception ID to clipboard"
                  title="Copy to clipboard"
                >
                  üìã
                </button>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Type:</span>
                <span class="detail-value">{{ selectedException()!.exceptionType }}</span>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Message:</span>
                <span class="detail-value">{{ selectedException()!.message }}</span>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Path:</span>
                <span class="detail-value">{{ selectedException()!.method }} {{ selectedException()!.path }}</span>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Status Code:</span>
                <span class="detail-value">{{ selectedException()!.statusCode }}</span>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Timestamp:</span>
                <span class="detail-value">{{ formatTimestamp(selectedException()!.timestampUtc) }}</span>
              </div>
              <div class="exception-detail-row">
                <span class="detail-label">Request ID:</span>
                <span class="detail-value">{{ selectedException()!.requestId }}</span>
              </div>
              @if (selectedException()!.remoteIp) {
                <div class="exception-detail-row">
                  <span class="detail-label">Remote IP:</span>
                  <span class="detail-value">{{ selectedException()!.remoteIp }}</span>
                </div>
              }
            </div>

            @if (selectedException()!.stackTrace) {
              <div class="stack-trace-section">
                <h3>Stack Trace</h3>
                <pre class="stack-trace">{{ selectedException()!.stackTrace }}</pre>
              </div>
            }
          </div>
          <div class="exception-modal-footer">
            <button 
              (click)="clearSelectedException()" 
              class="btn btn-primary"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Info Section -->
    <section class="info-section" aria-label="Dashboard information">
      <h2 class="sr-only">Dashboard Information</h2>
      <div class="info-card">
        <h3>‚ÑπÔ∏è About Health Checks</h3>
        <ul>
          <li><strong>Healthy:</strong> Component is functioning normally</li>
          <li><strong>Degraded:</strong> Component is working but with issues</li>
          <li><strong>Unhealthy:</strong> Component is not functioning properly</li>
          <li><strong>Auto-Refresh:</strong> Status updates every 30 seconds when enabled</li>
        </ul>
      </div>
    </section>
  }

  <!-- Loading State -->
  @if (loading() && !healthData()) {
    <div class="loading-container" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p>Loading health status...</p>
    </div>
  }
</div>
